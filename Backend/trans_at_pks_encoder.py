import ast
from raichu.visualize_cluster import *
from pikachu.general import *

transator_clade_to_transpact_clade={'Clade_142': 'Clade_74', 'Clade_40': 'Clade_29', 'Clade_46': 'Clade_34', 'Clade_98': 'Clade_126', 'Clade_92': 'Clade_34', 'Clade_125': 'Clade_64', 'Clade_9': 'Clade_10', 'Clade_95': 'Clade_123', 'Clade_141': 'Clade_47', 'Clade_35': 'Clade_11', 'Clade_28': 'Clade_1', 'Clade_138': 'Clade_80', 'Clade_94': 'Clade_49', 'Clade_139': 'Clade_79', 'Clade_112': 'Clade_80', 'Clade_111': 'Clade_80', 'Clade_80': 'Clade_60', 'Clade_25': 'Clade_12', 'Clade_127': 'Clade_66', 'Clade_2': 'Clade_89', 'Clade_44': 'Clade_33', 'Clade_45': 'Clade_33', 'Clade_78': 'Clade_36', 'Clade_7': 'Clade_111', 'Clade_140': 'Clade_116', 'Clade_12': 'Clade_39', 'Clade_96': 'Clade_105', 'Clade_121': 'Clade_53', 'Clade_11': 'Clade_12', 'Clade_82': 'Clade_64', 'Clade_67': 'Clade_92', 'Clade_116': 'Clade_71', 'Clade_26': 'Clade_23', 'Clade_8': 'Clade_6', 'Clade_81': 'Clade_60', 'Clade_34': 'Clade_19', 'Clade_126': 'Clade_68', 'Clade_129': 'Clade_63', 'Clade_115': 'Clade_71', 'Clade_65': 'Clade_70', 'Clade_27': 'Clade_41', 'Clade_86': 'Clade_90', 'Clade_21': 'Clade_93', 'Clade_103': 'Clade_83', 'Clade_134': 'Clade_107', 'Clade_76': 'Clade_55', 'Clade_38': 'Clade_108', 'Clade_30': 'Clade_4', 'Clade_128': 'Clade_66', 'Clade_104': 'Clade_101', 'Clade_100': 'Clade_66', 'Clade_43': 'Clade_105', 'Clade_36': 'Clade_75', 'Clade_84': 'Clade_48', 'Clade_42': 'Clade_31', 'Clade_23': 'Clade_90', 'Clade_13': 'Clade_45', 'Clade_49': 'Clade_5', 'Clade_118': 'Clade_42', 'Clade_32': 'Clade_40', 'Clade_88': 'Clade_86', 'Clade_53': 'Clade_50', 'Clade_70': 'Clade_77', 'Clade_51': 'Clade_69', 'Clade_74': 'Clade_93', 'Clade_31': 'Clade_3', 'Clade_90': 'Clade_65', 'Clade_14': 'Clade_87', 'Clade_73': 'Clade_82', 'Clade_64': 'Clade_61', 'Clade_122': 'Clade_48', 'Clade_52': 'Clade_48', 'Clade_39': 'Clade_30', 'Clade_10': 'Clade_30', 'Clade_1': 'Clade_8', 'Clade_101': 'Clade_67', 'Clade_130': 'Clade_66', 'Clade_99': 'Clade_62', 'Clade_68': 'Clade_93', 'Clade_135': 'Clade_52', 'Clade_33': 'Clade_104', 'Clade_124': 'Clade_63', 'Clade_79': 'Clade_7', 'Clade_5': 'Clade_44', 'Clade_136': 'Clade_30', 'Clade_55':'Clade_47', 'Clade_56':'Clade_69','Clade_57':'Clade_47',"Clade_61":"Clade_58","Clade_62":"Clade_113","Clade_66":"Clade_56","Clade_60":"Clade_69", "Clade_75":"Clade_79","Clade_83":"Clade_72","Clade_85":"Clade_49","Clade_89":"Clade_100","Clade_93":"Clade_34","Clade_97":"Clade_56","Clade_102":"Clade_60","Clade_108":"Clade_12","Clade_109":"Clade_26","Clade_100":"Clade_52","Clade_113":"Clade_47","Clade_114":"Clade_56","Clade_120":"Clade_75","Clade_123":"Clade_59","Clade_131":"Clade_47","Clade_132":"Clade_47","Clade_133":"Clade_47","Clade_137":"Clade_59"}

clade_to_tailoring_reactions={'Clade_33': [], 'Clade_73': [], 'Clade_128': ['KR'], 'Clade_109': ['AMT', 'KR', 'DH', 'ER'], 'Clade_72': ['AMT', 'KR', 'EDH'], 'Clade_61': ['KR', 'DH'], 'Clade_74': ['KR', 'DH'], 'Clade_55': ['KR', 'DH'], 'Clade_86': ['KR', 'DH'], 'Clade_75': [], 'Clade_108': ['SC'], 'Clade_110': ['KR', 'ZDH'], 'Clade_79': ['KR_B1'], 'Clade_3': ['DH'], 'Clade_4': ['DH'], 'Clade_34': ['KR'], 'Clade_36': ['KR'], 'Clade_49': ['KR'], 'Clade_60': ['KR', 'DH'], 'Clade_30': [], 'Clade_1': [], 'Clade_2': [], 'Clade_121': [], 'Clade_41': [], 'Clade_8': [], 'Clade_10': [], 'Clade_125': [], 'Clade_126': ['AH'], 'Clade_103': ['AMT'], 'Clade_99': ['AMT', 'KR'], 'Clade_93': ['KR', 'DH', 'ER', 'AMT'], 'Clade_90': ['KR', 'GDH', 'AMT'], 'Clade_47': ['AMT', 'KR', 'EDH'], 'Clade_48': ['AMT', 'KR', 'EDH'], 'Clade_22': ['AMT', 'KR'], 'Clade_84': ['KR', 'ZGDH', 'AMT '], 'Clade_58': ['ALMT', 'KR_A1 '], 'Clade_100': ['AMT', 'KR_B1'], 'Clade_80': ['AMT', 'KR_B1'], 'Clade_85': ['AMT', 'KR'], 'Clade_113': ['AMT', 'KR'], 'Clade_77': ['AH', 'KR'], 'Clade_53': ['KR'], 'Clade_39': [], 'Clade_42': ['KR', 'DH'], 'Clade_65': ['KR', 'DH'], 'Clade_68': ['KR', 'DH'], 'Clade_66': ['KR', 'DH'], 'Clade_107': ['KR', 'EDH'], 'Clade_31': ['KR', 'EDH'], 'Clade_62': ['KR', 'EDH'], 'Clade_57': ['KR', 'EDH'], 'Clade_64': ['KR', 'EDH'], 'Clade_70': ['KR', 'EDH'], 'Clade_63': ['KR', 'EDH'], 'Clade_71': [], 'Clade_89': [], 'Clade_127': [], 'Clade_45': [], 'Clade_19': [], 'Clade_67': [], 'Clade_114': [], 'Clade_120': [], 'Clade_40': [], 'Clade_44': [], 'Clade_11': [], 'Clade_123': ['SC'], 'Clade_23': ['SC'], 'Clade_38': ['KR', 'DH', 'ER'], 'Clade_26': ['SC'], 'Clade_12': ['KR', 'GDH'], 'Clade_105': ['KR', 'GDH'], 'Clade_5': ['KR', 'GDH'], 'Clade_106': ['KR', 'GDH'], 'Clade_6': [], 'Clade_7': [], 'Clade_104': [], 'Clade_92': [], 'Clade_119': ['0'], 'Clade_43': ['KR', 'ZDH'], 'Clade_69': ['KR', 'ZDH'], 'Clade_59': ['KR'], 'Clade_124': ['KR_A1'], 'Clade_122': ['KR_A1'], 'Clade_115': ['KR_A1'], 'Clade_111': ['KR_A1'], 'Clade_112': ['KR_A1'], 'Clade_81': ['KR_A1', 'OMT '], 'Clade_83': ['KR', 'OMT'], 'Clade_78': ['KR_B1'], 'Clade_56': ['KR_B1'], 'Clade_116': ['KR_B1'], 'Clade_87': ['KR', 'DH', 'ER', 'BMT'], 'Clade_101': ['KR', 'DH', 'BMT'], 'Clade_102': ['KR', 'DH', 'BMT'], 'Clade_97': ['KR', 'DH', 'BMT'], 'Clade_82': ['KR', 'EDH', 'BMT'], 'Clade_50': ['KR'], 'Clade_51': ['KR'], 'Clade_117': ['KR'], 'Clade_98': ['KR'], 'Clade_52': ['KR'], 'Clade_29': []}

clade_to_elongating={'Clade_33': 'non-elongating', 'Clade_73': 'non-elongating', 'Clade_128': 'elongating', 'Clade_109': 'non-elongating', 'Clade_72': 'non-elongating', 'Clade_61': 'non-elongating', 'Clade_74': 'non-elongating', 'Clade_55': 'non-elongating', 'Clade_86': 'non-elongating', 'Clade_75': 'non-elongating', 'Clade_108': 'non-elongating', 'Clade_110': 'non-elongating', 'Clade_79': 'non-elongating', 'Clade_3': 'non-elongating', 'Clade_4': 'non-elongating', 'Clade_34': 'non-elongating', 'Clade_36': 'non-elongating', 'Clade_49': 'non-elongating', 'Clade_60': 'non-elongating', 'Clade_30': 'elongating', 'Clade_1': 'elongating', 'Clade_2': 'elongating', 'Clade_121': 'elongating', 'Clade_41': 'elongating', 'Clade_8': 'elongating', 'Clade_10': 'elongating', 'Clade_125': 'elongating', 'Clade_126': 'elongating', 'Clade_103': 'elongating', 'Clade_99': 'elongating', 'Clade_93': 'elongating', 'Clade_90': 'elongating', 'Clade_47': 'elongating', 'Clade_48': 'elongating', 'Clade_22': 'elongating', 'Clade_84': 'elongating', 'Clade_58': 'elongating', 'Clade_100': 'elongating', 'Clade_80': 'elongating', 'Clade_85': 'elongating', 'Clade_113': 'elongating', 'Clade_77': 'elongating', 'Clade_53': 'elongating', 'Clade_39': 'elongating', 'Clade_42': 'elongating', 'Clade_65': 'elongating', 'Clade_68': 'elongating', 'Clade_66': 'elongating', 'Clade_107': 'elongating', 'Clade_31': 'elongating', 'Clade_62': 'elongating', 'Clade_57': 'elongating', 'Clade_64': 'elongating', 'Clade_70': 'elongating', 'Clade_63': 'elongating', 'Clade_71': 'elongating', 'Clade_89': 'elongating', 'Clade_127': 'elongating', 'Clade_45': 'elongating', 'Clade_19': 'elongating', 'Clade_67': 'elongating', 'Clade_114': 'elongating', 'Clade_120': 'elongating', 'Clade_40': 'elongating', 'Clade_44': 'elongating', 'Clade_11': 'elongating', 'Clade_123': 'elongating', 'Clade_23': 'elongating', 'Clade_38': 'elongating', 'Clade_26': 'elongating', 'Clade_12': 'elongating', 'Clade_105': 'elongating', 'Clade_5': 'elongating', 'Clade_106': 'elongating', 'Clade_6': 'elongating', 'Clade_7': 'elongating', 'Clade_104': 'elongating', 'Clade_92': 'elongating', 'Clade_119': 'elongating', 'Clade_43': 'elongating', 'Clade_69': 'elongating', 'Clade_59': 'elongating', 'Clade_124': 'elongating', 'Clade_122': 'elongating', 'Clade_115': 'elongating', 'Clade_111': 'elongating', 'Clade_112': 'elongating', 'Clade_81': 'elongating', 'Clade_83': 'elongating', 'Clade_78': 'elongating', 'Clade_56': 'elongating', 'Clade_116': 'elongating', 'Clade_87': 'elongating', 'Clade_101': 'elongating', 'Clade_102': 'elongating', 'Clade_97': 'elongating', 'Clade_82': 'elongating', 'Clade_50': 'elongating', 'Clade_51': 'elongating', 'Clade_117': 'elongating', 'Clade_98': 'elongating', 'Clade_52': 'elongating', 'Clade_29': 'elongating'}

clade_to_starter_substrate={'Clade_33': 'OC(=O)CC(S)=O', 'Clade_73': 'OC(=O)CC(S)=O', 'Clade_128': 'OC(C(O)=O)C(S)=O', 'Clade_109': 'CC(O)CC(S)=O', 'Clade_72': 'C\\C(O)=C/C(S)=O', 'Clade_61': 'OC(=O)CC(S)=O', 'Clade_74': 'OC(=O)CC(S)=O', 'Clade_55': 'OC(=O)CC(S)=O', 'Clade_86': 'OC(=O)CC(S)=O', 'Clade_75': 'CC1=NC(C)=CO1 CC1=NC(C)=CS8', 'Clade_108': 'OC(=O)CC(S)=O', 'Clade_110': '[H]\\C(O)=C\\C(S)=O', 'Clade_79': 'O[C@H](C(O)=O)C(S)=O', 'Clade_3': 'OC(C(O)=O)C(S)=O', 'Clade_4': 'OC(C(O)=O)C(S)=O', 'Clade_34': 'OC(=O)CC(S)=O', 'Clade_36': 'OC(=O)CC(S)=O', 'Clade_49': 'OC(C(O)=O)C(S)=O', 'Clade_60': 'OC(=O)CC(S)=O', 'Clade_30': 'C(C(=O)O)N', 'Clade_1': 'OC(=O)CC(S)=O', 'Clade_2': 'OC(=O)CC(S)=O', 'Clade_121': 'OC(=O)CC(S)=O', 'Clade_41': 'CC(S)=O', 'Clade_8': 'CCC(S)=O CC(S)=O', 'Clade_10': 'SC(=O)C1=CC=CC=C3', 'Clade_125': 'SC(=O)C1=CC=CC=C4', 'Clade_126': 'OC(O)CC(O)S', 'Clade_103': 'CC(O)CC(S)=O', 'Clade_99': 'CC(O)C(O)C(O)S', 'Clade_93': 'CC(O)CC(S)=O CC(O)C(O)C(S)=O CC(O)C(=O)C(S)=O', 'Clade_90': 'CC(O)CC(S)=O', 'Clade_47': 'C\\C(O)=C/C(S)=O', 'Clade_48': 'C\\C(O)=C/C(S)=O', 'Clade_22': 'CC(O)C(O)C(O)S CC(O)C(=O)C(O)S', 'Clade_84': 'C\\C(O)=C/C(S)=O', 'Clade_58': 'C[C@H](O)[C@H](O)C(O)S', 'Clade_100': 'CC(O)[C@@H](O)C(O)S', 'Clade_80': 'CC(O)[C@@H](O)C(O)S', 'Clade_85': 'CC(O)C(O)C(O)S', 'Clade_113': 'CC(O)C(O)C(O)S', 'Clade_77': 'OC(O)C(O)C(O)S', 'Clade_53': 'OC(O)CC(O)S OCC(O)C(O)S', 'Clade_39': 'OC(=O)CC(S)=O', 'Clade_42': '[H]\\C(O)=C/C(S)=O', 'Clade_65': '[H]\\C(O)=C/C(S)=O', 'Clade_68': '[H]\\C(O)=C/C(S)=O', 'Clade_66': '[H]\\C(O)=C/C(S)=O', 'Clade_107': '[H]\\C(O)=C/C(S)=O', 'Clade_31': '[H]\\C(O)=C/C(S)=O', 'Clade_62': '[H]\\C(O)=C/C(S)=O', 'Clade_57': '[H]\\C(O)=C/C(S)=O', 'Clade_64': '[H]\\C(O)=C/C(S)=O', 'Clade_70': '[H]\\C(O)=C/C(S)=O', 'Clade_63': '[H]\\C(O)=C/C(S)=O', 'Clade_71': 'OC(=O)C(=O)C(S)=O', 'Clade_89': 'OC(=O)C(=O)C(S)=O', 'Clade_127': 'OC(=O)C(=O)C(S)=O', 'Clade_45': 'C[C@@H](O)C(S)=O', 'Clade_19': 'COC(S)=O', 'Clade_67': 'OC(=O)CC(S)=O', 'Clade_114': 'OC(=O)CC(S)=O', 'Clade_120': 'OC(=O)CC(S)=O', 'Clade_40': 'OC(=O)CC(S)=O', 'Clade_44': 'OC(=O)CC(S)=O', 'Clade_11': 'OC(=O)CC(S)=O', 'Clade_123': 'OC(=O)CC(S)=O', 'Clade_23': 'OC(=O)CC(S)=O', 'Clade_38': 'OC(=O)CC(S)=O', 'Clade_26': 'OC(=O)CC(S)=O', 'Clade_12': 'OC(=O)CC(S)=O', 'Clade_105': 'OC(=O)CC(S)=O', 'Clade_5': 'OC(=O)CC(S)=O', 'Clade_106': 'OC(=O)CC(S)=O', 'Clade_6': 'OC(=O)CC(S)=O', 'Clade_7': 'CC(S)=O', 'Clade_104': 'CC(S)=O SC(=O)C1=CC=CC=C3', 'Clade_92': 'OC(=O)CC(S)=O', 'Clade_119': 'O[C@@H](C(O)=O)C(S)=O', 'Clade_43': '[H]\\C(O)=C\\C(S)=O', 'Clade_69': '[H]\\C(O)=C\\C(S)=O', 'Clade_59': 'OC(C(O)=O)C(S)=O', 'Clade_124': 'O[C@@H](C(O)=O)C(S)=O', 'Clade_122': 'O[C@@H](C(O)=O)C(S)=O', 'Clade_115': 'O[C@@H](C(O)=O)C(S)=O', 'Clade_111': 'O[C@@H](C(O)=O)C(S)=O', 'Clade_112': 'O[C@@H](C(O)=O)C(S)=O', 'Clade_81': 'CO[C@@H](C(O)=O)C(S)=O', 'Clade_83': 'COC(C(O)=O)C(S)=O', 'Clade_78': 'O[C@H](C(O)=O)C(S)=O', 'Clade_56': 'O[C@H](C(O)=O)C(S)=O', 'Clade_116': 'O[C@H](C(O)=O)C(S)=O', 'Clade_87': 'OC(=O)C(=C)C(S)=O CC(C(O)=O)C(S)=O', 'Clade_101': '[H]\\C(O)=C(/C)C(S)=O', 'Clade_102': '[H]\\C(O)=C(/C)C(S)=O', 'Clade_97': '[H]\\C(O)=C(/C)C(S)=O', 'Clade_82': '[H]\\C(O)=C(/C)C(S)=O', 'Clade_50': 'OC(C(O)=O)C(S)=O', 'Clade_51': 'OC(C(O)=O)C(S)=O', 'Clade_117': 'OC(C(O)=O)C(S)=O', 'Clade_98': 'OC(C(O)=O)C(S)=O O\\C=C\\C(S)=O', 'Clade_52': 'OC(C(O)=O)C(S)=O O\\C=C\\C(S)=O', 'Clade_29': 'OC(C(O)=O)C(S)=O OC(=O)C(=O)C(S)=O'}

example_cluster=  [['module_1', 'starter_module_trans_at_pks',"malonylcoa"],
                           ['module_2', 'elongation_module_trans_at_pks', 'Clade_13', ['KR_B2']],
                           ['module_3', 'elongation_module_trans_at_pks', 'Clade_96', ['KR_A1']],
                           ['module_4', 'elongation_module_nrps', 'alanine', []],
                           ['module_5', 'elongation_module_trans_at_pks', 'Clade_36', ['KR', 'DH', 'ER']],
                           ['module_6', 'elongation_module_pks', 'CC(C(O)=O)C(S)=O', ['KR_A1']],
                           ['module_7', 'terminator_module_trans_at_pks', 'Clade_60', ['KR_A1']]]
example_cluster=  [['module_1', 'starter_module_trans_at_pks',"malonylcoa"],
                           ['module_2', 'elongation_module_trans_at_pks', 'Clade_13', ['KR_B2']],
                           ['module_3', 'elongation_module_trans_at_pks', 'Clade_96', ['KR_A1']],
                           ['module_4', 'elongation_module_trans_at_pks', 'Clade_78', ['KR_A1']],
                           ['module_5', 'elongation_module_trans_at_pks', 'Clade_78', ['KR_A1']],
                           ['module_6', 'elongation_module_trans_at_pks', 'Clade_38', ['KR_A1']],
                           ['module_7', 'elongation_module_nrps', 'alanine', []],
                           ['module_8', 'elongation_module_trans_at_pks', 'Clade_36', ['KR', 'DH']],
                           ['module_9', 'elongation_module_pks', 'methoxymalonylacp', ['KR_A1']],
                           ['module_10', 'terminator_module_trans_at_pks', 'Clade_60', ['KR_A1']]]
def translate_trans_at_pks_cluster_to_cis_at_pks(trans_at_pks_cluster):
    cis_at_pks_cluster=[]
    #translates transator input into transpact clades
    for index, trans_at_module in enumerate(trans_at_pks_cluster):
            if "Clade" in str(trans_at_module):
                trans_at_module[2]=transator_clade_to_transpact_clade[trans_at_module[2]]
    for index, trans_at_module in enumerate(trans_at_pks_cluster):
        cis_at_module=[]
        if index<len(trans_at_pks_cluster)-1:
            next_trans_at_module=trans_at_pks_cluster[index+1]
            if trans_at_module[1]=="starter_module_trans_at_pks" and next_trans_at_module[1]=="elongation_module_trans_at_pks":
                try:
                    cis_at_module=[trans_at_module[0],"starter_module_pks",clade_to_starter_substrate[next_trans_at_module[2]]]
                except:
                        cis_at_module=[trans_at_module[0],"starter_module_pks","OC(=O)CC(S)=O"]
                # try:
                #     cis_at_module=[trans_at_module[0],"starter_module_pks",clade_to_starter_substrate[next_trans_at_module[2]],[]]
                # except:
                #     try:
                #         cis_at_module=[trans_at_module[0],"starter_module_pks","OC(=O)CC(S)=O",clade_to_tailoring_reactions[next_trans_at_module[2]]]
                #     except:
                #         cis_at_module=[trans_at_module[0],"starter_module_pks","OC(=O)CC(S)=O",[]]
            elif trans_at_module[1]=="starter_module_trans_at_pks" and not next_trans_at_module[1]=="elongation_module_trans_at_pks":
                cis_at_module=[trans_at_module[0],"starter_module_pks","OC(=O)CC(S)=O"]
            elif trans_at_module[1]=="elongation_module_trans_at_pks" and next_trans_at_module[1]=="elongation_module_trans_at_pks":
                cis_at_module=[trans_at_module[0],"elongation_module_pks","OC(=O)CC(S)=O",clade_to_tailoring_reactions[next_trans_at_module[2]],clade_to_elongating[trans_at_module[2]]]
            elif trans_at_module[1]=="elongation_module_trans_at_pks" and not next_trans_at_module[1]=="elongation_module_trans_at_pks":
                cis_at_module=[trans_at_module[0],"elongation_module_pks","OC(=O)CC(S)=O",trans_at_module[3],clade_to_elongating[trans_at_module[2]]]
            else:
                cis_at_module=trans_at_module+["elongating"]
        else:
            if trans_at_module[1]=="terminator_module_trans_at_pks":
                cis_at_module=[trans_at_module[0],"terminator_module_pks","OC(=O)CC(S)=O",trans_at_module[3],clade_to_elongating[trans_at_module[2]]]
            elif trans_at_module[1]=="elongation_module_trans_at_pks":
                cis_at_module=[trans_at_module[0],"elongation_module_pks","OC(=O)CC(S)=O",trans_at_module[3],clade_to_elongating[trans_at_module[2]]]
            else:
                cis_at_module=trans_at_module+["elongating"]
        cis_at_pks_cluster+=[cis_at_module]
    return cis_at_pks_cluster
if __name__ == "__main__":
    print(example_cluster)
    cis_at_pks_cluster=translate_trans_at_pks_cluster_to_cis_at_pks(example_cluster)
    print(cis_at_pks_cluster)
    cis_at_pks_cluster=ast.literal_eval(str(cis_at_pks_cluster).replace("OC(=O)CC(S)=O","malonylcoa").replace(", 'elongating'","").replace(", 'non-elongating'",""))
    intermediate=cluster_to_structure(cis_at_pks_cluster)
    intermediate=thioesterase_linear_product(intermediate)
    intermediate=draw_structure(intermediate)
